version: '4.46'

services:
  api:
    build:
      context: .
      dockerfile: app.Dockerfile
    volumes:
      - ./app:/app
      - ./uploads:/uploads
      - ./alembic:/app/alembic
      - ./alembic.ini:/app/alembic.ini
    ports:
      - 8000:8000
    environment:
      DATABASE_HOSTNAME: "${DATABASE_HOSTNAME}"
      DATABASE_PORT: "${DATABASE_PORT}"
      DATABASE_NAME: "${DATABASE_NAME}"
      DATABASE_USER: "${DATABASE_USER}"
      DATABASE_PASSWORD: "${DATABASE_PASSWORD}"
    depends_on:
      - db
    networks:
      - default_network
    restart: unless-stopped

  db:
    image: postgres:17.0
    environment:
      POSTGRES_DB: "${DATABASE_NAME}"
      POSTGRES_USER: "${DATABASE_USER}"
      POSTGRES_PASSWORD: "${DATABASE_PASSWORD}"
    ports:
      - "${DATABASE_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - default_network
    restart: unless-stopped


  bot:
    build:
      context: .
      dockerfile: bot.Dockerfile
    volumes:
      - ./bot:/bot
    environment:
      BOT_TOKEN: "${BOT_TOKEN}"
      DEBUG: "${DEBUG:-false}"
      BACKEND_BASE_URL: "http://api:8000"
    restart: unless-stopped
    depends_on:
      - api
      - db
    networks:
      - default_network

volumes:
  postgres_data:

networks:
  default_network: